- name: Create /opt/ollama directory
  ansible.builtin.file:
    path: /opt/ollama
    state: directory
    mode: '0755'

- name: Create Docker Compose for Ollama
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: '/opt/ollama/docker-compose.yml'
    mode: '0644'

- name: Pull and start Docker Compose for Ollama
  community.docker.docker_compose_v2:
    project_src: /opt/ollama
    pull: always
    state: present

- name: Wait for Ollama container to be ready
  ansible.builtin.wait_for:
    host: localhost
    port: 11434
    delay: 5
    timeout: 60

- name: Pull Ollama models
  ansible.builtin.shell: |
    docker exec ollama ollama pull {{ item.name }}:{{ item.version }}
  loop: "{{ ollama_models }}"
  register: pull_result
  until: pull_result.rc == 0
  retries: 3
  delay: 10

- name: Copy Modelfile template to container for tool-compatible variants
  ansible.builtin.shell: |
    docker exec ollama bash -c "cat > /tmp/{{ item.name | replace('/', '_') }}-{{ item.version }}-tools.Modelfile << 'EOF'
    FROM {{ item.name }}:{{ item.version }}
    PARAMETER num_ctx {{ item.context_size }}
    EOF"
  loop: "{{ ollama_models | selectattr('create_tool_variant', 'equalto', true) | list }}"
  when: item.create_tool_variant | default(false)
  register: modelfile_result
  changed_when: modelfile_result.rc == 0

- name: Create tool-compatible model variants with increased context
  ansible.builtin.shell: |
    docker exec ollama ollama create {{ item.name }}:{{ item.version }}-tools -f /tmp/{{ item.name | replace('/', '_') }}-{{ item.version }}-tools.Modelfile
  loop: "{{ ollama_models | selectattr('create_tool_variant', 'equalto', true) | list }}"
  when: item.create_tool_variant | default(false)
  register: variant_result
  changed_when: "'success' in variant_result.stdout or variant_result.rc == 0"

- name: Create nginx conf
  template:
    src: ollama-nginx.conf
    dest: '/etc/nginx/sites-available/ollama-nginx.conf'
    owner: root
    group: root
    mode: 0777

- name: Create a symbolic link for nginx conf
  ansible.builtin.file:
    src: '/etc/nginx/sites-available/ollama-nginx.conf'
    dest: '/etc/nginx/sites-enabled/ollama-nginx.conf'
    owner: root
    group: root
    state: link

- name: restart nginx
  service: name=nginx state=restarted